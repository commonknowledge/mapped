# Generated by Django 4.1.2 on 2022-11-30 14:25

from django.db import migrations, models

import django_jsonform.models.fields

import hub.models


def numerical_comparators():
    return [
        dict(field_lookup="lt", title="is less than"),
        dict(field_lookup="gte", title="is equal or greater than"),
    ]


def year_comparators():
    return [
        dict(field_lookup="year__lt", title="before year"),
        dict(field_lookup="year__gte", title="since year"),
    ]


def populate_datasets(apps, schema_editor):
    persondata_names = [
        "wikipedia",
        "party",
        "parlid",
        "mp_last_elected",
        "facebook",
        "twitter",
        "twfyid",
        "mp_first_elected",
        "mp_election_majority",
    ]

    DataSet = apps.get_model("hub", "DataSet")

    DataSet.objects.filter(name__in=persondata_names).update(
        table="person__persondata",
    )
    DataSet.objects.exclude(name__in=persondata_names).update(
        table="areadata",
    )
    DataSet.objects.filter(data_type="year").update(
        comparators=year_comparators(),
        default_value=2019,  # last election year
    )
    DataSet.objects.filter(data_type="percent").update(
        comparators=numerical_comparators(),
        default_value=50,  # right down the middle
    )
    DataSet.objects.filter(data_type__in=["float", "integer"]).update(
        comparators=numerical_comparators(),
    )


def reverse_noop(apps, schema_editor):
    pass


class Migration(migrations.Migration):

    dependencies = [
        ("hub", "0024_areadata_float_areadata_int_persondata_float_and_more"),
    ]

    operations = [
        migrations.AddField(
            model_name="dataset",
            name="comparators",
            field=django_jsonform.models.fields.JSONField(
                default=hub.models.DataSet.comparators_default
            ),
        ),
        migrations.AddField(
            model_name="dataset",
            name="default_value",
            field=models.CharField(blank=True, max_length=50, null=True),
        ),
        migrations.AddField(
            model_name="dataset",
            name="options",
            field=django_jsonform.models.fields.JSONField(
                blank=True, default=hub.models.DataSet.options_default
            ),
        ),
        migrations.AddField(
            model_name="dataset",
            name="table",
            field=models.CharField(
                choices=[
                    ("areadata", "AreaData"),
                    ("person__persondata", "PersonData"),
                ],
                max_length=20,
                null=True,
            ),
        ),
        migrations.RunPython(populate_datasets, reverse_noop),
    ]
